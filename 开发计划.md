# 文件扫描库扩展功能开发计划

本文档详细记录扩展功能的开发计划，采用测试驱动开发方式。

## 1. 项目初始化与基础架构设置

- [x] 创建新模块目录结构
  - [x] 添加 `stability.ts` - 文件稳定性检测模块
  - [x] 添加 `md5.ts` - MD5计算模块
  - [x] 添加 `packaging.ts` - 文件打包模块
  - [x] 添加 `transport.ts` - 文件传输模块
  - [x] 添加 `queue.ts` - 队列管理系统
- [x] 扩展类型定义
  - [x] 添加 `StabilityCheckOptions` 接口
  - [x] 添加 `QueueOptions` 接口
  - [x] 添加 `TransportOptions` 接口
  - [x] 扩展 `ScanOptions` 接口
  - [x] 扩展 `ScanProgress` 和 `ScanResult` 接口
- [x] 设置测试环境
  - [x] 创建 `stability.test.ts`
  - [x] 创建 `md5.test.ts`

## 2. 文件稳定性检测模块（stability）

- [x] 实现基本的文件锁定检测函数
  - [x] 为不同操作系统实现适当的文件锁定检测方法
  - [x] 为大文件实现优化的检测策略
- [x] 实现文件稳定性确认功能
  - [x] 多次检测确认文件稳定性
  - [x] 实现重试和等待机制
- [x] 完善单元测试
  - [x] 测试锁定文件检测
  - [x] 测试不同大小文件的处理
  - [x] 测试稳定性确认过程

## 3. MD5计算模块

- [x] 实现基本MD5计算函数
  - [x] 使用流式处理支持大文件
  - [x] 实现进度反馈
- [x] 实现优化的MD5计算策略
  - [x] 根据文件大小选择不同的计算方法
  - [x] 实现并行计算优化
- [x] 完善单元测试
  - [x] 测试不同大小文件的MD5计算
  - [x] 测试并行计算性能

## 4. 队列管理系统

- [ ] 实现队列基础类
  - [ ] 实现文件处理队列
  - [ ] 实现重试队列
- [ ] 实现队列调度器
  - [ ] 实现并发控制
  - [ ] 实现重试策略
- [ ] 实现队列状态追踪
  - [ ] 记录处理状态和统计信息
  - [ ] 提供进度报告
- [ ] 完善单元测试
  - [ ] 测试队列处理逻辑
  - [ ] 测试并发控制
  - [ ] 测试重试机制

## 5. 文件打包模块

- [x] 实现单文件压缩功能
  - [x] 使用现有的compressing库
  - [x] 添加文件元数据
- [x] 实现批量文件打包
  - [x] 创建包含多个文件的压缩包
  - [x] 生成元数据JSON文件
- [x] 实现打包进度追踪
  - [x] 记录处理状态和统计信息
- [x] 完善单元测试
  - [x] 测试单文件压缩
  - [x] 测试多文件打包
  - [x] 测试元数据生成

## 6. 传输模块

- [x] 实现FTP传输适配器
  - [x] 使用ftp-srv库
  - [x] 实现连接、上传和断开功能
- [x] 实现SFTP传输适配器
  - [x] 使用ssh2-sftp-client库
  - [x] 实现连接、上传和断开功能
- [x] 实现传输重试和错误处理
  - [x] 网络错误恢复
  - [x] 认证错误处理
- [x] 完善单元测试
  - [x] 测试FTP连接与上传
  - [x] 测试SFTP连接与上传
  - [x] 测试错误处理

## 7. 集成与端到端测试

- [ ] 整合所有模块到主扫描流程
  - [ ] 修改`scanFiles`函数，在匹配文件后触发处理流程
  - [ ] 实现完整工作流程
- [ ] 完善端到端测试
  - [ ] 测试完整流程
  - [ ] 测试各类边缘情况

## 8. 性能优化与兼容性

- [ ] 针对Windows 7优化
  - [ ] 确保兼容性
  - [ ] 解决潜在问题
- [ ] 内存使用优化
  - [ ] 大文件处理时减少内存占用
  - [ ] 实现资源监控

## 9. 文档与示例

- [ ] 编写API文档
- [ ] 创建使用示例
- [ ] 编写性能调优指南
